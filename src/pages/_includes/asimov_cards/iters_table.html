<div class="card">
	<div class="card-header d-flex justify-content-between align-items-center" style="height: 5em">
		<h3 class="card-title">Tutti</h3>
		<div class="col-6 col-sm-4 col-md-2 col-xl-auto py-3">
			<a href="#" class="btn w-100 btn-icon" aria-label="Aggiorna">
				{% include ui/icon.html icon="refresh"%}
			</a>
		</div>
	</div>
	<div class="card-body border-bottom py-3">

		<div class="d-flex">
			<div class="text-secondary">
				Mostra
				<div class="mx-2 d-inline-block">
					<input id="display_n_results" type="text" class="form-control form-control-sm" value="20" size="3" aria-label="DDLs count">
				</div>
				elementi
			</div>

			<div class="ms-auto text-secondary">
				Cerca:
				<div class="ms-2 d-inline-block">
					<input type="text" class="form-control form-control-sm" aria-label="Search ddl">
				</div>
			</div>
		</div>

	</div>
	<div class="table-responsive">

		<table class="table card-table table-vcenter text-nowrap datatable">
			<thead>
			<tr>
				<th class="w-1">No. {% include ui/icon.html icon="chevron-up" class="icon-sm icon-thick" %}</th>
				<th> Ramo {% include parts/dropdown/filter_ramo.html %}</th>
				<th>Titolo {% include ui/icon.html icon="chevron-up" class="icon-sm icon-thick" %}</th>
				<th>1ยบ firm. {% include ui/icon.html icon="chevron-up" class="icon-sm icon-thick" %}
				</th>
				<th>Gruppo {% include ui/icon.html icon="chevron-up" class="icon-sm icon-thick" %} {% include
					parts/dropdown/filter_gruppo.html %}
				</th>
				<th>Stato {% include ui/icon.html icon="chevron-up" class="icon-sm icon-thick" %} {% include
					parts/dropdown/filter_stato.html %}
				</th>
				<th>Ultimo agg. {% include ui/icon.html icon="chevron-up" class="icon-sm icon-thick" %} {% include
					parts/dropdown/filter_actions.html %}
				</th>

				<th>Segui</th>
			</tr>

			</thead>
			<style>
				/* Style for regular td elements */
				.table td {
					max-width: 10em; /* Set a default maximum width for td elements */
					white-space: nowrap;
					overflow: hidden;
					text-overflow: ellipsis;
				}

				/* Style for long_td elements that inherit from the regular td style */
				.table td.long_td {
					max-width: 400px; /* Set a longer maximum width for elements with the 'long_td' class */
				}
			</style>

			<tbody id="iters_table_body">

			<tr id="templateRow" style="display: none;">
				<td id ="numero_fase">926</span></td>
				<td id ="ramo">S</td>
				<td id ="titolo" class="long_td">
					Ratifica ed esecuzione dell'Accordo tra la Repubblica italiana e ...
				</td>
				<td id ="presentatori">
					Giancarlo Giorgetti
				</td>
				<td id ="nome_gruppo">
					PD
				</td>
				<td id ="stato_ddl_semp">
					<span class="badge bg-green me-1"></span>
				</td>
				<td id ="data_stato_ddl"> 15 Gen 24</td>

				<td id ="seguito" class="text-end">
					<a href="#" class="btn w-100 btn-icon" aria-label="segui">
						{% include ui/icon.html icon="plus"%}
					</a>
				</td>
			</tr>


			</tbody>
		</table>
	</div>
	<div class="card-footer d-flex align-items-center" style="display: none">
<!--		<p class="m-0 text-secondary"> <span id="num_displayed_results">50</span> risultati di <span id="num_total_results">100</span>-->
			{% include asimov_cards/iters_table_pagination.html class="m-0 ms-auto" %}</p>

	</div>
</div>

<script>

	var ddls = [];

	function fill_table() {

		// Pagination
		// var page = document.querySelector('.pagination .active a').dataset.page || 1;
		var page = null;
		var storedActiveItem = localStorage.getItem('active_item');
		if (storedActiveItem) {
			page = parseInt(storedActiveItem, 10);
		}
		else{
			page = 1;
			updatePaginationUI(page)
		}

		// Num results to display
		var num_results = document.getElementById('display_n_results').value
		num_results = parseInt(num_results, 10);

		// Slice
		var startIndex = (page - 1) * num_results;
		var endIndex = page * num_results;
		var pageData = ddls.slice(startIndex, endIndex);

		var tbody = document.getElementById('iters_table_body');
		var templateRow = document.getElementById('templateRow');
		// Remove all children using a loop
		while (tbody.children.length>1) {
			tbody.removeChild(tbody.lastChild);
		}

		var fields = ['numero_fase', 'ramo', 'titolo', 'presentatori', 'nome_gruppo', 'stato_ddl_semp', 'data_stato_ddl', 'seguito'];

		// Fill a row
		pageData.forEach(function (item) {
			// Fill a column
			// Clone the template row
			var tr = templateRow.cloneNode(true);
			while (tr.firstChild) {
				tr.removeChild(tr.firstChild);
			}
			tr.removeAttribute('style');
			tr.removeAttribute('id');

			fields.forEach(function(field) {
				var template = document.getElementById(field);
				var newElement = template.cloneNode(true);
				newElement.removeAttribute('id');
				newElement.textContent = item[field];
				tr.appendChild(newElement);
			});
			// var num_displayed_results = document.getElementById('num_displayed_results')
			// num_displayed_results.textContent = tbody.childElementCount
			// var num_total_results = document.getElementById('num_total_results')
			// num_total_results.textContent = ddls.length

			tbody.appendChild(tr);
		});
	}

	function fetch_data(order_by) {
		// Function to get the selected options from the dropdowns
		function getSelectedOptions(selector) {
			var selectedOptions = [];
			document.querySelectorAll(selector + ' input[type=checkbox]:checked').forEach(function (checkbox) {
				selectedOptions.push(checkbox.value);
			});
			return selectedOptions;
		}

		// // Get the limit from the form
		// var limit = document.querySelector('input[aria-label="DDLs count"]').value;

		// Get the keyword from the form
		var keyword = document.querySelector('input[aria-label="Search ddl"]').value;


		// Get the selected options from the dropdowns
		var options = {
			// Assuming the dropdowns have class 'dropdown-filter'
			ramo: getSelectedOptions('div.dropdown-menu'),
			presentatore: getSelectedOptions('.dropdown-filter.filter_actions'),
		};

		// Prepare the data for the API request
		var data = {
			options: options,
			order_by: order_by
		};

		var data_debug = [{
			"id_fase": "57864",
			"ddl": "http://dati.senato.it/ddl/57864",
			"titolo": "Conversione in legge del decreto-legge 18 gennaio 2024, n. 4, recante disposizioni urgenti in materia di amministrazione straordinaria delle imprese di carattere strategico",
			"stato_ddl": "assegnato (no esame)",
			"data_stato_ddl": "2024-01-19",
			"tipo_iniziativa": "Governativa",
			"id_iter": "53411",
			"assegnazione": null,
			"relatore": null,
			"data_presentazione": null,
			"fase": null,
			"legislatura": null,
			"natura": "di conversione di decreto-legge",
			"numero_fase": "986",
			"numero_fase_compatto": null,
			"presentato_trasmesso": "presentato",
			"progressivo_iter": "1",
			"ramo": "S",
			"testo_presentato": "urn:nir:senato.repubblica:disegno.legge:19.legislatura;986",
			"testo_approvato": null,
			"primo_firmatario": "1",
			"senatore": null,
			"presentatori": 'Sen. Silvio Berlusconi'
		}];
		var debug = false
		if(debug){
			ddls = data_debug
			fill_table()
		}
		else{
			// Perform the API request
			var endpoint = 'http://127.0.0.1:8000/users/me/fetch_personalized_iters/'
			if(keyword){
				endpoint += '?keyword=' + keyword
			}
			fetch(endpoint, {
				method: 'POST',
				headers: {
					'Accept': 'application/json',
					// Assuming the token is stored in a meta tag
					'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data)
			})
				.then(response => response.json())
				.then(responseData => {
					// Handle the response
					console.log(responseData);
					ddls = responseData
					fill_table()

				})
				.catch(error => {
					// Handle the error
					console.error(error);
				});
		}

	}




	document.addEventListener("DOMContentLoaded", function (){
		fetch_data({
		field: "data_stato_ddl",
		desc: true
		})
	});
	document.addEventListener("DOMContentLoaded", updatePaginationUI);

	// document.addEventListener("DOMContentLoaded", function () {
	// 	fill_table();
	// });

</script>